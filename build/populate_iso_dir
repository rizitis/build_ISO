#!/bin/sh
# Author: Didier Spaier, Paris, France
#
# this version inspired by this script from George Vlahavas:
# https://github.com/gapan/iso-creation/blob/master/01-downloadpackages.sh
# previous version is build_list_of_packages.sh.prev in the same directory.
# But while Salix arrange the packages in the ISO in sub directories of salix,
# we will instead put all of them directly in slint
# shellcheck disable=SC1090
[ "$#" -ne 1 ] && echo "usage: $0 [salix|slackware|slint]" && exit
distribution="$1"
if [ ! "$distribution" = salix ] && [ ! "$distribution" = slackware ] && [ ! "$distribution" = slint ]; then
	echo "$distribution= is not a supported distribution"
	exit
fi
. ./set_variables_"$distribution"
USER=$(stat -c %U .)
[ "$(id -u)" -ne 0 ] && echo "Run this script as root." && exit
[ -d "$ISODIR" ] && echo "$ISODIR exist. Press Enter to remove it or Ctrl-C to bail out."
read -r
rm -rf "$ISODIR"
SLAPTGETISO="$ROOTDIR/files-in-initrd/slapt-getrc.iso$distribution"
mkdir -p "$ISODIR/slint/locales"
echo "Copy in $ISODIR the packages to put in the ISO"
slapt-get --clean
echo slapt-get -u -c "$SLAPTGETISO"
slapt-get -u -c "$SLAPTGETISO"
rm -f /tmp/errors_from_populate_iso.sh
for SET in $SETS; do
	echo "*** processing the $SET set of packages ***"
	while read -r i; do
	echo "Installing $i"
		slapt-get -d --no-dep --reinstall -c "$SLAPTGETISO" -i "$i"
		if [ -s /tmp/errors_from_populate_iso.sh ]; then
			echo "Some packages could not be found. They are listed in:"
			echo " check: /tmp/errors_from_populate_iso.sh"
			exit
		fi
	done < "$ROOTDIR"/sets/"$SET" 2>>/tmp/errors_from_populate_iso.sh

done
if [ -s /tmp/errors_from_populate_iso.sh ]; then
	echo "Some packages could not be found. They are listed in:"
	echo " check/tmp/errors_from_populate_iso.sh"
	exit
fi
find /var/slapt-get -name "*t?z"|while read -r i; do
	cp "$i" "$ISODIR/slint"
done
# We need spkg in the installer for slackware thus in the ISO
if [ "$DISTRIBUTION" = slackware ]; then
	find "$SLINTREPO" -name "spkg*txz" -exec cp '{}' "$ISODIR"/slint \; || exit
fi
if [ "$DISTRIBUTION" = slint ]; then 
	echo "Copy in $ISODIR the packages in $SLACKROOT/extra/aspell-word-lists"
	cp "$SLACKROOT"/extra/aspell-word-lists/*t?z "$ISODIR"/slint/locales
	echo "Copy in $ISODIR the packages in $SLINTREPO/locales"
	cp "$SLINTREPO"/locales/*t?z "$ISODIR"/slint/locales
	echo "Copy in $ISODIR selected flite voice packages" "$ISODIR"/slint/locales
	while read -r i; do
		cp "$SLINTREPO"/voices/flite/"${i}"*t?z "$ISODIR"/slint/locales
	done <"$ROOTDIR"/doc/flite_voices_included_in_the_ISO
	echo "Copy in $ISODIR selected mbrola voice packages"
	while read -r i ; do
		cp "$SLINTREPO"/voices/mbrola/"${i}"*t?z "$ISODIR"/slint/locales
	done < "$ROOTDIR"/doc/mbrola_voices_included_in_the_ISO
else
	# for other distributions than Slint put in $ISODIR/installer the
	# packages that will be installed in the initramfs by rc.S
	slapt-get -u -c "$ROOTDIR"/scripts/slapt-getrc.iso
	slapt-get --clean
	while read -r i; do
		echo "$i" >>/tmp/populate_iso
		[ "$i" ] && slapt-get -d --no-dep --reinstall -c "$ROOTDIR"/scripts/slapt-getrc.iso -i "$i"
	done < "$ROOTDIR"/sets/addonsinstaller 2>>/tmp/errors_from_populate_iso.sh
	if [ -s /tmp/errors_from_populate_iso.sh ]; then
		echo "Some packages could not be found. They are listed in:"
		echo " check/tmp/errors_from_populate_iso.sh"
		exit
	fi
	mkdir -p "$ISODIR/installer"
	find /var/slapt-get -name "*t?z"|while read -r i; do
		cp "$i" "$ISODIR/installer"
	done
fi
chown -R "$USER":users "$ISODIR"
